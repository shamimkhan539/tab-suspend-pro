name: Master Branch Pipeline

on:
    push:
        branches:
            - master
        paths-ignore:
            - "**.md"
            - "LICENSE"
            - ".gitignore"

jobs:
    # First, run all validations and tests
    validate-and-test:
        runs-on: ubuntu-latest
        outputs:
            version: ${{ steps.version.outputs.version }}
            manifest-version: ${{ steps.version.outputs.manifest_version }}
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Calculate next version
              id: version
              run: |
                  # Get all existing tags
                  git fetch --tags

                  # Get all tags and find the highest semantic version
                  echo "ğŸ” Finding latest semantic version..."
                  HIGHEST_MAJOR=0
                  HIGHEST_MINOR=0
                  HIGHEST_PATCH=0

                  # Loop through all tags to find the highest version
                  for tag in $(git tag --list | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$'); do
                    VERSION_NUM=$(echo $tag | sed 's/v//')
                    MAJOR=$(echo $VERSION_NUM | cut -d. -f1)
                    MINOR=$(echo $VERSION_NUM | cut -d. -f2)
                    PATCH=$(echo $VERSION_NUM | cut -d. -f3)
                    
                    # Compare versions
                    if [ $MAJOR -gt $HIGHEST_MAJOR ] || 
                       ([ $MAJOR -eq $HIGHEST_MAJOR ] && [ $MINOR -gt $HIGHEST_MINOR ]) || 
                       ([ $MAJOR -eq $HIGHEST_MAJOR ] && [ $MINOR -eq $HIGHEST_MINOR ] && [ $PATCH -gt $HIGHEST_PATCH ]); then
                      HIGHEST_MAJOR=$MAJOR
                      HIGHEST_MINOR=$MINOR
                      HIGHEST_PATCH=$PATCH
                    fi
                  done

                  if [ $HIGHEST_MAJOR -eq 0 ] && [ $HIGHEST_MINOR -eq 0 ] && [ $HIGHEST_PATCH -eq 0 ]; then
                    # No valid tags exist, start with v1.0.0
                    NEXT_VERSION="v1.0.0"
                    echo "ğŸ“‹ No existing tags found, starting with v1.0.0"
                  else
                    LATEST_TAG="v$HIGHEST_MAJOR.$HIGHEST_MINOR.$HIGHEST_PATCH"
                    echo "ğŸ“‹ Latest existing tag: $LATEST_TAG"
                    
                    # Increment patch version
                    HIGHEST_PATCH=$((HIGHEST_PATCH + 1))
                    NEXT_VERSION="v$HIGHEST_MAJOR.$HIGHEST_MINOR.$HIGHEST_PATCH"
                  fi

                  echo "ğŸš€ Next version will be: $NEXT_VERSION"
                  echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT
                  echo "manifest_version=$(echo $NEXT_VERSION | sed 's/v//')" >> $GITHUB_OUTPUT

            - name: Validate manifest.json
              run: |
                  echo "ğŸ” Validating manifest.json..."
                  if ! cat manifest.json | python -m json.tool > /dev/null 2>&1; then
                    echo "âŒ manifest.json is not valid JSON"
                    exit 1
                  fi
                  echo "âœ… manifest.json is valid JSON"

            - name: Check required files
              run: |
                  echo "ğŸ” Checking required files..."
                  required_files=("manifest.json" "background.js" "content.js" "popup.html" "popup.js" "options.html" "options.js" "suspended.html" "suspended.js")

                  for file in "${required_files[@]}"; do
                    if [ ! -f "$file" ]; then
                      echo "âŒ Required file missing: $file"
                      exit 1
                    else
                      echo "âœ… Found: $file"
                    fi
                  done

            - name: Check icons
              run: |
                  echo "ğŸ” Checking icons..."
                  required_icons=("icons/icon16.png" "icons/icon32.png" "icons/icon48.png" "icons/icon128.png")
                  for icon in "${required_icons[@]}"; do
                    if [ ! -f "$icon" ]; then
                      echo "âŒ Required icon missing: $icon"
                      exit 1
                    else
                      echo "âœ… Found: $icon"
                    fi
                  done

            - name: Validate JavaScript syntax
              run: |
                  echo "ğŸ” Checking JavaScript syntax..."
                  js_files=("background.js" "content.js" "popup.js" "options.js" "suspended.js")

                  for file in "${js_files[@]}"; do
                    if ! node -c "$file" 2>/dev/null; then
                      echo "âŒ Syntax error in: $file"
                      exit 1
                    else
                      echo "âœ… Syntax OK: $file"
                    fi
                  done

            - name: Create test build
              run: |
                  echo "ğŸ”¨ Creating test build..."
                  mkdir -p build-test
                  cp manifest.json build-test/
                  cp *.js build-test/
                  cp *.html build-test/
                  cp -r icons build-test/
                  cp LICENSE build-test/
                  echo "âœ… Test build created successfully"

    # After validation passes, create tag and trigger release
    auto-tag-and-release:
        runs-on: ubuntu-latest
        needs: validate-and-test
        permissions:
            contents: write
        steps:
            - name: Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Check if tag already exists
              id: tag_check
              run: |
                  if git rev-parse "refs/tags/${{ needs.validate-and-test.outputs.version }}" >/dev/null 2>&1; then
                    echo "exists=true" >> $GITHUB_OUTPUT
                    echo "ğŸ·ï¸  Tag ${{ needs.validate-and-test.outputs.version }} already exists"
                  else
                    echo "exists=false" >> $GITHUB_OUTPUT
                    echo "ğŸ·ï¸  Tag ${{ needs.validate-and-test.outputs.version }} does not exist - will create"
                  fi

            - name: Update manifest and create tag
              if: steps.tag_check.outputs.exists == 'false'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"

                  # Update manifest.json with new version
                  NEW_VERSION="${{ needs.validate-and-test.outputs.manifest-version }}"
                  sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$NEW_VERSION\"/" manifest.json

                  echo "ğŸ“ Updated manifest.json to version $NEW_VERSION"

                  # Commit the version update
                  git add manifest.json
                  git commit -m "chore: bump version to $NEW_VERSION [skip ci]"
                  git push origin master

                  # Create annotated tag with commit message info
                  COMMIT_MSG=$(git log -1 --pretty=%B)
                  git tag -a "${{ needs.validate-and-test.outputs.version }}" -m "Release ${{ needs.validate-and-test.outputs.version }}" -m "Auto-tagged from master branch" -m "Latest commit: $COMMIT_MSG"

                  git push origin "${{ needs.validate-and-test.outputs.version }}"

                  echo "ğŸ‰ Created and pushed tag: ${{ needs.validate-and-test.outputs.version }}"
                  echo "ğŸš€ This will trigger the release workflow automatically"

            - name: Create extension package
              if: steps.tag_check.outputs.exists == 'false'
              run: |
                  echo "ğŸ”¨ Creating extension package for release..."
                  mkdir -p extension-package
                  cp manifest.json extension-package/ || true
                  cp *.js extension-package/ 2>/dev/null || true
                  cp *.html extension-package/ 2>/dev/null || true
                  cp -r icons extension-package/ 2>/dev/null || true
                  cp LICENSE extension-package/ 2>/dev/null || true
                  cd extension-package
                  zip -r ../tab-suspend-pro-${{ needs.validate-and-test.outputs.version }}.zip .
                  cd ..
                  echo "âœ… Package created: tab-suspend-pro-${{ needs.validate-and-test.outputs.version }}.zip"

            - name: Create GitHub Release (direct)
              if: steps.tag_check.outputs.exists == 'false'
              uses: softprops/action-gh-release@v2
              with:
                  tag_name: ${{ needs.validate-and-test.outputs.version }}
                  files: tab-suspend-pro-${{ needs.validate-and-test.outputs.version }}.zip
                  generate_release_notes: true
                  draft: false
                  prerelease: false
                  name: "tab-suspend-pro-${{ needs.validate-and-test.outputs.version }}"
                  body: |
                      ## Chrome Extension Release ${{ needs.validate-and-test.outputs.version }}

                      ### Installation
                      1. Download the `tab-suspend-pro-${{ needs.validate-and-test.outputs.version }}.zip` file
                      2. Extract the contents
                      3. Open Chrome and go to `chrome://extensions/`
                      4. Enable "Developer mode"
                      5. Click "Load unpacked" and select the extracted folder

                      ### What's Changed
                      See the auto-generated release notes below for detailed changes.
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Tag already exists
              if: steps.tag_check.outputs.exists == 'true'
              run: |
                  echo "âš ï¸  Tag ${{ needs.validate-and-test.outputs.version }} already exists"
                  echo "ğŸ’¡ If you want to create a new release, please:"
                  echo "   1. Update the version in manifest.json"
                  echo "   2. Push the changes to master"
                  echo "   3. A new tag will be created automatically"

    # Summary job
    pipeline-summary:
        runs-on: ubuntu-latest
        needs: [validate-and-test, auto-tag-and-release]
        if: always()
        steps:
            - name: Pipeline Summary
              run: |
                  echo "## ğŸš€ Master Branch Pipeline Summary"
                  echo ""
                  echo "**Version:** ${{ needs.validate-and-test.outputs.version }}"
                  echo "**Validation:** ${{ needs.validate-and-test.result == 'success' && 'âœ… Passed' || 'âŒ Failed' }}"
                  echo "**Auto-tagging:** ${{ needs.auto-tag-and-release.result == 'success' && 'âœ… Completed' || needs.auto-tag-and-release.result == 'skipped' && 'â­ï¸ Skipped' || 'âŒ Failed' }}"
                  echo ""
                  if [ "${{ needs.validate-and-test.result }}" = "success" ] && [ "${{ needs.auto-tag-and-release.result }}" = "success" ]; then
                    echo "ğŸ‰ **Pipeline completed successfully!**"
                    echo "ğŸ·ï¸  New tag created: ${{ needs.validate-and-test.outputs.version }}"
                    echo "ğŸ“¦ Release workflow will be triggered automatically"
                  elif [ "${{ needs.validate-and-test.result }}" = "success" ] && [ "${{ needs.auto-tag-and-release.result }}" = "skipped" ]; then
                    echo "âœ… **Validation passed, but tag already exists**"
                    echo "ğŸ’¡ Update version in manifest.json for new release"
                  else
                    echo "âŒ **Pipeline failed - please check the logs above**"
                  fi
