name: Pull Request Validation

on:
    pull_request:
        branches:
            - master
        types: [opened, synchronize, reopened]

jobs:
    pr-validation:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Calculate next version
              id: version
              run: |
                  # Get all existing tags
                  git fetch --tags

                  # Get all tags and find the highest semantic version
                  echo "ğŸ” Finding latest semantic version..."
                  HIGHEST_MAJOR=0
                  HIGHEST_MINOR=0
                  HIGHEST_PATCH=0

                  # Loop through all tags to find the highest version
                  for tag in $(git tag --list | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$'); do
                    VERSION_NUM=$(echo $tag | sed 's/v//')
                    MAJOR=$(echo $VERSION_NUM | cut -d. -f1)
                    MINOR=$(echo $VERSION_NUM | cut -d. -f2)
                    PATCH=$(echo $VERSION_NUM | cut -d. -f3)
                    
                    # Compare versions
                    if [ $MAJOR -gt $HIGHEST_MAJOR ] || 
                       ([ $MAJOR -eq $HIGHEST_MAJOR ] && [ $MINOR -gt $HIGHEST_MINOR ]) || 
                       ([ $MAJOR -eq $HIGHEST_MAJOR ] && [ $MINOR -eq $HIGHEST_MINOR ] && [ $PATCH -gt $HIGHEST_PATCH ]); then
                      HIGHEST_MAJOR=$MAJOR
                      HIGHEST_MINOR=$MINOR
                      HIGHEST_PATCH=$PATCH
                    fi
                  done

                  if [ $HIGHEST_MAJOR -eq 0 ] && [ $HIGHEST_MINOR -eq 0 ] && [ $HIGHEST_PATCH -eq 0 ]; then
                    # No valid tags exist, start with v1.0.0
                    NEXT_VERSION="v1.0.0"
                    LATEST_TAG="none"
                    echo "ğŸ“‹ No existing tags found, starting with v1.0.0"
                  else
                    LATEST_TAG="v$HIGHEST_MAJOR.$HIGHEST_MINOR.$HIGHEST_PATCH"
                    echo "ğŸ“‹ Latest existing tag: $LATEST_TAG"
                    
                    # Increment patch version
                    HIGHEST_PATCH=$((HIGHEST_PATCH + 1))
                    NEXT_VERSION="v$HIGHEST_MAJOR.$HIGHEST_MINOR.$HIGHEST_PATCH"
                  fi

                  echo "ğŸš€ Next version will be: $NEXT_VERSION"
                  echo "version=$NEXT_VERSION" >> $GITHUB_OUTPUT
                  echo "manifest_version=$(echo $NEXT_VERSION | sed 's/v//')" >> $GITHUB_OUTPUT
                  echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT

            - name: Check version status
              id: version_check
              run: |
                  echo "latest_tag=${{ steps.version.outputs.latest_tag }}" >> $GITHUB_OUTPUT
                  echo "next_version=${{ steps.version.outputs.version }}" >> $GITHUB_OUTPUT
                  echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

                  if [ "$OLD_VERSION" != "$NEW_VERSION" ]; then
                    echo "version_changed=true" >> $GITHUB_OUTPUT
                    echo "ğŸ”„ Version changed: $OLD_VERSION â†’ $NEW_VERSION"
                  else
                    echo "version_changed=false" >> $GITHUB_OUTPUT
                    echo "ğŸ“‹ Version unchanged: $NEW_VERSION"
                  fi

            - name: Validate manifest.json
              run: |
                  echo "ğŸ” Validating manifest.json..."
                  if ! cat manifest.json | python -m json.tool > /dev/null 2>&1; then
                    echo "âŒ manifest.json is not valid JSON"
                    exit 1
                  fi
                  echo "âœ… manifest.json is valid JSON"

            - name: Check all required files
              run: |
                  echo "ğŸ” Checking required files..."
                  required_files=("manifest.json" "background.js" "content.js" "popup.html" "popup.js" "options.html" "options.js" "suspended.html" "suspended.js")
                  missing_files=()

                  for file in "${required_files[@]}"; do
                    if [ ! -f "$file" ]; then
                      missing_files+=("$file")
                      echo "âŒ Missing: $file"
                    else
                      echo "âœ… Found: $file"
                    fi
                  done

                  if [ ${#missing_files[@]} -gt 0 ]; then
                    echo "âŒ Missing required files: ${missing_files[*]}"
                    exit 1
                  fi

            - name: Validate JavaScript syntax
              run: |
                  echo "ğŸ” Checking JavaScript syntax..."
                  js_files=("background.js" "content.js" "popup.js" "options.js" "suspended.js")
                  syntax_errors=()

                  for file in "${js_files[@]}"; do
                    if ! node -c "$file" 2>/dev/null; then
                      syntax_errors+=("$file")
                      echo "âŒ Syntax error in: $file"
                    else
                      echo "âœ… Syntax OK: $file"
                    fi
                  done

                  if [ ${#syntax_errors[@]} -gt 0 ]; then
                    echo "âŒ JavaScript syntax errors found in: ${syntax_errors[*]}"
                    exit 1
                  fi

            - name: Check icons
              run: |
                  echo "ğŸ” Checking icon files..."
                  required_icons=("icons/icon16.png" "icons/icon32.png" "icons/icon48.png" "icons/icon128.png")
                  missing_icons=()

                  for icon in "${required_icons[@]}"; do
                    if [ ! -f "$icon" ]; then
                      missing_icons+=("$icon")
                      echo "âŒ Missing: $icon"
                    else
                      echo "âœ… Found: $icon"
                    fi
                  done

                  if [ ${#missing_icons[@]} -gt 0 ]; then
                    echo "âŒ Missing required icons: ${missing_icons[*]}"
                    exit 1
                  fi

            - name: Test build creation
              run: |
                  echo "ğŸ”¨ Testing build creation..."
                  mkdir -p pr-build-test

                  cp manifest.json pr-build-test/
                  cp *.js pr-build-test/
                  cp *.html pr-build-test/
                  cp -r icons pr-build-test/
                  cp LICENSE pr-build-test/ 2>/dev/null || echo "LICENSE file not found, skipping"

                  echo "âœ… Build test successful"

            - name: PR Summary
              run: |
                  echo "## ğŸ“‹ Pull Request Validation Summary"
                  echo ""
                  echo "**Latest Tag:** ${{ steps.version_check.outputs.latest_tag }}"
                  echo "**Next Version:** ${{ steps.version_check.outputs.next_version }}"
                  echo ""
                  echo "ğŸ‰ **When this PR is merged to master:**"
                  echo "- âœ… All validations will run"
                  echo "- ğŸ“ Manifest.json will be updated to version ${{ steps.version.outputs.manifest_version }}"
                  echo "- ğŸ·ï¸ Tag ${{ steps.version.outputs.version }} will be created automatically"
                  echo "- ğŸ“¦ Release workflow will be triggered"
                  echo "- ğŸš€ GitHub release will be published"
                  echo ""
                  echo "**All Checks:** âœ… Passed"
